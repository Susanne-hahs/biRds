---
title: "Project 8"
author: "biRd-studio"
date: "2023-12-03"
output: html_document
bibliography: "BIOL3140.bib"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(rgbif)
library(tidyverse)
library(MuMIn)
library(rnoaa)
library(data.table)
library(ggmap) 
library(usmap) 
library(magick)
library(cowplot) 
library(lme4)
library(car) 
library(data.table) 
library(knitr)
library(kableExtra)
```

## Introduction 
The term trans-Gulf migrants (TGMs) are a group of birds undertaking extensive non-stop flights across the Gulf of Mexico, ultimately landing between Texas and Florida. These birds are integral members of a larger cohort migrating from Central and South American to more temperate regions. Evolutionary trade-offs, as discussed by @Newton2008 and @Smith2005, hinge on whether early arrivals have better chances of finding mates and breeding multiple times or if later arrivals benefit from increased food availability. 

Researchers are particularly interested in TGM arrival dates due to their implications for fitness, especially considering the influence of climate change on these dates. According to @Both2006, rising spring temperatures may lead to a decline in TGM populations if they fail to adjust their breeding site arrival dates accordingly. Additionally studies from @Cook2021 show that cold weather and high population density adversely affect survival rates. As climate change induces irregular temperature and weather patterns, TGMs face fluctuations in survival rates. 

In 2002m the Cornell Laboratory of Ornithology and the National Audubon Society introduced eBird, a program empowering citizen scientists and birders to share their observations, creating a comprehensive bird sighting database. This initiative has emerged as a crucial tool for advancing avian biology studies.

Our project aims to leverage eBird and meteorological data to comprehend the impact of local weather conditions on TGM arrivals in Massachusetts. Through this, we seek to enhance our understanding of how TGMs respond to changing environmental conditions and contribute valuable insights to avian biology research. 

## Methods 
Our initial step involved five distinct trans-Gulf migrant (TGM) bird species, each belonging to different families. The species that we chose are the following: (insert the 5 names when chosen). Human observations of these species in Massachusetts, extracted from the eBird database, constituted our primary data source. In order to extract information from the eBird database, we utilized the occ_data() function from rgbif, which queries GBIF occurrences, therefore allowing us to acquire the occurrence data for the selected species. Additionally, the dataset facilitated the determination of the Julian day for each species, enabling an examination of the influence of temperature and wind along their migration route to Massachusetts. 

Our investigation encompassed three key locations along the migration path: Mobile AL (Gulf initiation point), Charlotte, NC (midpoint), and Boston, MA (final destination). Weather data from each location was retrieved using a NOAA website token. Subsequently, we plotted the eBird data to depict the proportion of the population that arrived and the predicted arrival time for each species. Furthermore, a plot was generated to illustrate the temporal variations in the Julian day over the years, facilitating an assessment of climate impact on arrival dates. 

Wind direction was computed using weather data, and the results were integrated with the species data. Utilizing the frollmean() function, we calculated the mean of weather variables for both 5 and 10 days preceding the arrival day. 

Moreover, we constructed a Linear Mixed-effect Model using the lme package for both the single-day and two-week average weather datasets. An Anova test was conducted to identify the model with the best fit, and model testing was done with the dredge() function. This approach allowed us to comprehensively explore the intricate relationship between weather parameters and the arrival dynamics of the selected TGM bird species along their migratory journey. 

## Results 
```{r, include=FALSE}
raven <- occ_data(scientificName = "Corvus corax", stateProvince="Maine", limit=200,year=2018)

ME<- map_data('state', 'maine')

raven.p <- ggplot(ME, aes(long,lat,group=subregion) )+
  geom_polygon(colour = "gray",fill="gray90")+geom_point(data=raven[[2]],aes(x=decimalLongitude,y=decimalLatitude,size=individualCount),alpha=0.3,inherit.aes = F)+ coord_quickmap()+theme_void()

raven.p2 <- ggdraw() +
  draw_image("https://www.allaboutbirds.org/guide/assets/photo/63739491-480px.jpg",scale = 0.3,halign=0,valign=1) +
  draw_plot(raven.p)
print(raven.p2)

lapply(raven,head)

species <- c("Myiarchus crinitus","Icterus galbula","Pheucticus ludovicianus","Coccyzus americanus","Setophaga caerulescens")

y <- paste0("2000",",","2019")
m <- paste0("4",",","5")

dat.l <-list()

for(s in species){
  
n.obs <-  occ_data(scientificName = s,year=y,month=m,limit=0,country="US",basisOfRecord = "HUMAN_OBSERVATION",stateProvince="Massachusetts")$meta$count 

print(n.obs)


dat.l[[paste0(s)]] <- occ_data(scientificName = s,year=y,month=m,
                               limit=n.obs,country="US",
                               basisOfRecord = "HUMAN_OBSERVATION",
                               stateProvince="Massachusetts")[[2]]}

dat <- rbindlist(dat.l,fill=T)

head(dat)

saveRDS(data,"massbird.data.RDS")

dat%>%
  group_by(year,species)%>%
  summarise(count=sum(individualCount,na.rm = T))%>%
  ggplot(aes(x=year,y=count,col=species))+geom_point()

options(noaakey = "MSwYPqBXDAEWVsfKiGtHDmZODJaXABNT")
sts <- c(
  "GHCND:USW00013894", #Mobible, AL 2k away about 10 days away @200 km/day
  "GHCND:USW00013881", #Charlotte, NC 1000 km away about 6 days away @200 km/day
  "GHCND:USW00014739" #Boston
)
bos <- ncdc_stations(stationid = "GHCND:USW00014739")
print(bos)

Sys.setenv(NOAA_KEY = "MSwYPqBXDAEWVsfKiGtHDmZODJaXABNT")

sta.d <- bind_rows( 
  lapply(sts,function(x) ncdc_stations(stationid = x)$data ) 
  )%>%
  mutate(usmap_transform(.,input_names = c("longitude","latitude"),output_names = c("longitude.1", "latitude.1")))%>% 
  mutate(name=str_sub(name, -5,-4))%>%
  mutate(migr.day=c(10,5,0))%>%
  separate(id,into = c("station.type","id"))%>%
        print()
plot_usmap(
  include = c(.northeast_region,.south_region,.east_north_central)
)+geom_point(data=sta.d,aes(x=longitude.1,y=latitude.1,col=name),size=5)+geom_label(data=sta.d,aes(x=longitude.1,y=latitude.1,col=name,label=name),size=5,nudge_x = 1e6*0.25)+theme(legend.position = "none")

weather.d <- meteo_pull_monitors(sta.d$id,date_min = "2000-01-01")

mc<- dat%>%
  group_by(year)%>%
  mutate(date=as.Date(paste0(year,"-",month,"-",day)),
         j.day=julian(date,origin=as.Date(paste0(unique(year),"-01-01")))
  )%>%
  group_by(species,year,j.day,date)%>%
  summarise(day.tot=sum(individualCount,na.rm=T))%>%
  group_by(species,year)%>%
  mutate(prop=cumsum(day.tot/sum(day.tot,na.rm = T)))%>%
  filter(year>1999)

mc%>%
  ggplot(aes(j.day,prop))+geom_point()+facet_wrap(year~.)

mc.pred <- mc%>%
  group_by(year)%>%
 summarize(
   pred=predict(nls(prop~SSlogis(j.day,Asym, xmid, scal)),newdata=data.frame(j.day=min(j.day):max(j.day))),
   j.day=min(j.day):max(j.day),
  )%>%
  left_join(mc%>%dplyr::select(j.day,date))

mc%>%
  ggplot(aes(j.day,prop))+geom_point(aes=0.3)+geom_line(data=mc.pred,aes(x=j.day,y=pred),col="blue",size=2)+facet_wrap(year~.) 

mc.arrive.date <-mc.pred%>%
  group_by(year)%>%
  filter(j.day==j.day[which.min(abs(pred-0.25))])

mc.arrive.date%>%
  ggplot(aes(year,j.day))+geom_point()

weather.d <- weather.d%>%
  mutate(year=as.integer(str_sub(date,1,4)), 
         date=as.Date(date))%>%
  group_by(year)%>% 
 mutate(j.day=julian(date,origin=as.Date(paste0(unique(year),"-01-01"))), 
  date2=date,
  wdir.rad=(180-abs(wdf2-180))*pi/180, 
  wvec=cos(wdir.rad)*-1*awnd 
  )%>% 
  dplyr::select(id,year,date2,j.day,tmin,tmax,wvec)%>% 
  left_join(sta.d%>%select(id,name,migr.day))%>% 
  mutate(j.day=j.day+migr.day)
mc.arr.weath <- mc.arrive.date%>%
  left_join(weather.d)%>%
  left_join(mc%>%dplyr::select(year,date,j.day))

weather.wk <-weather.d %>% 
  group_by(year,name) %>% 
  mutate(wk.tmin = frollmean(tmin, n=14,align="right"),
         wk.tmax = frollmean(tmax, n=14,align="right"),
         wk.wvec = frollmean(wvec, n=14,align="right")
         )%>%
  dplyr::select(j.day,date2,name,wk.tmin,wk.tmax,wk.wvec)

mc.arr.weath2 <- mc.arrive.date%>%
  left_join(weather.wk)

mc.lmer <- lmer(j.day~tmin*tmax*wvec+(1|name),mc.arr.weath,na.action = "na.fail")

Anova(mc.lmer)

mc.lmer2 <- lmer(j.day~wk.tmin*wk.tmax*wk.wvec+(1|name),mc.arr.weath2,na.action = "na.fail")
Anova(mc.lmer2) 

mc.arr.aic <- dredge(mc.lmer2,fixed = c("wk.tmin","wk.tmax","wk.wvec"),)

mc.kb <- kable(mc.arr.aic[1:4,],caption = "Fit values for nested models of the most complicated lme model")

kable_styling(mc.kb)

best.lmer <-  lmer(j.day~wk.tmin+wk.tmax+wk.wvec+(1|name),mc.arr.weath2,na.action = "na.fail")

Anova(best.lmer)
```


## Discussion 


## Author Contributions
Alexandra Hoogendijk: Results

Ava Skogstrom	

Tara Gerjarusak	

Susanne Hahs: Introduction, Methods, Bibliography


## References
